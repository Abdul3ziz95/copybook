
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</title>

<style>
:root{--p:#0d6efd;--s:#28a745;--bg:#f4f6f8}
body{margin:0;font-family:Tahom,a;background:var(--bg)}
header{background:var(--p);color:#fff;padding:15px;text-align:center;font-size:20px}
.tabs{display:flex;background:#fff}
.tabs button{flex:1;padding:12px;border:none;background:#fff}
.tabs button.active{background:var(--p);color:#fff}
.section{display:none;padding:15px}
.section.active{display:block}
.card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px}
input,select{width:100%;padding:12px;margin:6px 0;font-size:15px;border-radius:8px;border:1px solid #ccc}
button.action{background:var(--s);color:#fff;border:none;padding:14px;width:100%;border-radius:8px;font-size:16px}
button.secondary{background:#ddd;padding:10px;width:100%;border:none;border-radius:8px;margin-top:6px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 22px;border-radius:30px;display:none;z-index:100}
.toast.show{display:block}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:none;flex-direction:column;z-index:10}
.modal header{display:flex;gap:6px;padding:10px;border-bottom:1px solid #ddd}
.modal-content{padding:15px;overflow:auto;flex:1}
.list-item{background:#eef6ff;padding:14px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.detail p{margin:8px 0}
.detail img{width:100%;border-radius:10px;margin-top:10px}
.date-icon{cursor:pointer;padding-left: 5px;display:inline;position:relative;top:-2px;}
input[type="file"]:before {
    content: "Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
    color: #777;
    font-size: 14px;
    display: block;
    padding: 8px;
    text-align: center;
    background: #f4f6f8;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin: 10px 0;
    cursor: pointer;
}
</style>
</head>

<body>

<header>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</header>

<div class="tabs">
<button class="active" onclick="openTab('expenses')">ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª</button>
<button onclick="openTab('rights')">ğŸ¤ Ø­Ù‚ÙˆÙ‚</button>
<button onclick="openTab('debts')">ğŸ“Œ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
<button onclick="openTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
</div>

<div id="expenses" class="section active">
<div class="card">
<input id="eAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<select id="eType">
<option value="">Ø§Ù„ÙØ¦Ø©</option>
<option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option><option>ÙÙˆØ§ØªÙŠØ±</option>
<option>Ø¥ÙŠØ¬Ø§Ø±</option><option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
</select>
<input id="eDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<input id="eDate" type="datetime-local">
<span class="date-icon" onclick="openDatePicker()">ğŸ“…</span>
<input id="eImg" type="file" accept="image/*">
<button class="action" onclick="addExpense()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('exp')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="rights" class="section">
<div class="card">
<input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ">
<select id="rType">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
<option>Ø¯ÙŠÙ†</option><option>Ø³Ù„ÙØ©</option><option>Ø¨ÙŠØ¹</option>
</select>
<input id="rAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<input id="rDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<input id="rDate" type="datetime-local">
<span class="date-icon" onclick="openDatePicker()">ğŸ“…</span>
<select id="rStatus">
<option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
<option>Ù…Ø¯ÙÙˆØ¹</option>
<option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>
<button class="action" onclick="addRight()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('rig')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="debts" class="section">
<div class="card">
<select id="dType">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
<option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ù…Ø§Ø¡</option><option>Ø¥Ù†ØªØ±Ù†Øª</option>
<option>Ø¥ÙŠØ¬Ø§Ø±</option><option>Ø¯ÙŠÙ†</option>
</select>
<input id="dAmount" type="text" placeholder="ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº" oninput="formatAmount(this)" pattern="[0-9]*" inputmode="decimal">
<input id="dDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<input id="dDate" type="datetime-local">
<span class="date-icon" onclick="openDatePicker()">ğŸ“…</span>
<select id="dStatus">
<option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
<option>Ù…Ø¯ÙÙˆØ¹</option>
<option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
</select>
<button class="action" onclick="addDebt()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('deb')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<div id="stats" class="section">
<div class="card">
<h3>ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="sExpTotal">0</b></p>
<p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <b id="sExpCount">0</b></p>
<p>Ø£Ø¹Ù„Ù‰ ÙØ¦Ø©: <b id="sTopCat">â€”</b></p>
</div>
<div class="card">
<h3>ğŸ¤ Ø§Ù„Ø­Ù‚ÙˆÙ‚</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="sRigTotal">0</b></p>
<p>Ù…Ø¯ÙÙˆØ¹: <b id="sRigPaid">0</b></p>
<p>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹: <b id="sRigUnpaid">0</b></p>
</div>
<div class="card">
<h3>ğŸ“Œ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</h3>
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b id="sDebTotal">0</b></p>
<p>Ù…Ø¯ÙÙˆØ¹: <b id="sDebPaid">0</b></p>
<p>Ù…ØªØ¨Ù‚ÙŠ: <b id="sDebUnpaid">0</b></p>
</div>
</div>

<div class="modal" id="logModal">
<header>
<input id="search" placeholder="ğŸ” Ø¨Ø­Ø«" oninput="renderLog()">
<button onclick="closeLog()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content" id="logContent"></div>
</div>

<div class="modal" id="detailModal">
<header>
<button onclick="closeDetailAndClearEditMode()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content detail" id="detailContent"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===================================================
// 1. Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB
// ===================================================
const IDB_NAME = "MySmartBudgetDB";
const IDB_VERSION = 1;
const STORE_NAMES = ["exp", "rig", "deb"]; 
let db = { exp: [], rig: [], deb: [] }; 
let IDB_connection = null; 

let currentLog = "", editMode = null;

function initDB() {
  return new Promise((resolve, reject) => {
    if (!window.indexedDB) {
        toastMsg("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… IndexedDB.");
        return reject(new Error("IndexedDB not supported."));
    }

    const request = indexedDB.open(IDB_NAME, IDB_VERSION);

    request.onerror = (e) => {
      console.error("IndexedDB error:", e.target.error);
      reject(e.target.error);
    };

    request.onsuccess = (e) => {
      IDB_connection = e.target.result;
      console.log("IndexedDB opened successfully.");
      resolve(IDB_connection);
      loadAllData().then(updateStats);
    };

    request.onupgradeneeded = (e) => {
      IDB_connection = e.target.result;
      STORE_NAMES.forEach(storeName => {
        if (!IDB_connection.objectStoreNames.contains(storeName)) {
          IDB_connection.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
        }
      });
      console.log("Database upgrade complete.");
    };
  });
}

initDB();

function saveData(storeName, data) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.put(data);

    request.onsuccess = () => resolve(request.result);
    request.onerror = (e) => reject(e.target.error);
  });
}

function deleteFromDB(storeName, id) {
  return new Promise((resolve, reject) => {
    if (!IDB_connection) return reject(new Error("Database not connected."));

    const transaction = IDB_connection.transaction([storeName], "readwrite");
    const store = transaction.objectStore(storeName);
    const request = store.delete(id); 

    request.onsuccess = () => resolve();
    request.onerror = (e) => reject(e.target.error);
  });
}

function loadStoreData(storeName) {
  return new Promise((resolve) => {
    if (!IDB_connection) return resolve([]); 
    
    const transaction = IDB_connection.transaction([storeName], "readonly");
    const store = transaction.objectStore(storeName);
    const request = store.getAll();

    request.onsuccess = (e) => resolve(e.target.result.reverse());
    request.onerror = () => resolve([]);
  });
}

async function loadAllData() {
    const [expData, rigData, debData] = await Promise.all([
        loadStoreData('exp'),
        loadStoreData('rig'),
        loadStoreData('deb')
    ]);
    db.exp = expData;
    db.rig = rigData;
    db.deb = debData;
    if (logModal.style.display === "flex") renderLog();
}


// ===================================================
// 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
// ===================================================

function formatAmount(e) {
  e.value = e.value.replace(/[^\d.]/g, ''); 
  const parts = e.value.split('.');
  if (parts.length > 2) {
    e.value = parts[0] + '.' + parts[1].slice(0, 2);
  }
}

function parseAmount(amount) {
  return parseFloat(String(amount).replace(/[^\d.-]/g, '')) || 0;
}

function toastMsg(m) {
  toast.textContent = m;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2000);
}

function openTab(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
  // **Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©:** Ù…Ø³Ø­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø§Ù„Ø®Ø·Ø£
  editMode = null; 
}

function clearFields() {
  eAmount.value = eDesc.value = eType.value = eDate.value = eImg.value = "";
  rName.value = rAmount.value = rDesc.value = rDate.value = rType.value = rStatus.value = "";
  dType.value = dAmount.value = dDesc.value = dDate.value = dStatus.value = "";
}

// **Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø³Ø­ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„**
function closeDetailAndClearEditMode() {
  detailModal.style.display = "none";
  editMode = null; 
}

// ===================================================
// 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù (CRUD)
// ===================================================

async function addExpense() { 
  if (!eAmount.value || !eType.value || !eDate.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

  const isEditing = editMode && editMode.type === "exp";
  const oldData = isEditing ? db.exp[editMode.index] : {};

  const data = { 
    Ø§Ù„Ù…Ø¨Ù„Øº: eAmount.value, 
    Ø§Ù„ÙØ¦Ø©: eType.value, 
    Ø§Ù„ÙˆØµÙ: eDesc.value, 
    Ø§Ù„ØªØ§Ø±ÙŠØ®: eDate.value, 
    ØµÙˆØ±Ø©: oldData.ØµÙˆØ±Ø© || null
  };

  if (isEditing) {
      data.id = oldData.id;
  }
  
  const done = async () => {
    try {
        await saveData('exp', data); 
        toastMsg(isEditing ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ØªÙ… Ø§Ù„Ø­ÙØ¸");
        editMode = null; 
        await loadAllData(); 
        clearFields();
        updateStats();
    } catch (error) {
        toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
        console.error(error);
    }
  };

  if (eImg.files[0]) {
    const r = new FileReader();
    r.onload = () => { data.ØµÙˆØ±Ø© = r.result; done(); };
    r.readAsDataURL(eImg.files[0]);
  } else {
      done(); 
  }
}

async function addRight() {
  if (!rName.value || !rAmount.value || !rDate.value || !rStatus.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "rig";
  const oldData = isEditing ? db.rig[editMode.index] : {};

  const data = { 
    Ø§Ù„Ø§Ø³Ù…: rName.value, 
    Ø§Ù„Ù†ÙˆØ¹: rType.value, 
    Ø§Ù„Ù…Ø¨Ù„Øº: rAmount.value, 
    Ø§Ù„ÙˆØµÙ: rDesc.value, 
    Ø§Ù„ØªØ§Ø±ÙŠØ®: rDate.value, 
    Ø§Ù„Ø­Ø§Ù„Ø©: rStatus.value 
  };
  
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('rig', data);
      toastMsg(isEditing ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ØªÙ… Ø§Ù„Ø­ÙØ¸");
      editMode = null;
      await loadAllData(); 
      clearFields();
      updateStats();
  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

async function addDebt() {
  if (!dType.value || !dAmount.value || !dDate.value || !dStatus.value) return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  
  const isEditing = editMode && editMode.type === "deb";
  const oldData = isEditing ? db.deb[editMode.index] : {};

  const data = { 
    Ø§Ù„Ù†ÙˆØ¹: dType.value, 
    Ø§Ù„Ù…Ø¨Ù„Øº: dAmount.value, 
    Ø§Ù„ÙˆØµÙ: dDesc.value, 
    Ø§Ù„ØªØ§Ø±ÙŠØ®: dDate.value, 
    Ø§Ù„Ø­Ø§Ù„Ø©: dStatus.value 
  };
  
  if (isEditing) {
      data.id = oldData.id;
  }
  
  try {
      await saveData('deb', data);
      toastMsg(isEditing ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ØªÙ… Ø§Ù„Ø­ÙØ¸");
      editMode = null;
      await loadAllData(); 
      clearFields();
      updateStats();
  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Console.");
      console.error(error);
  }
}

function openLog(t) {
  currentLog = t;
  logModal.style.display = "flex";
  renderLog();
}

function closeLog() { logModal.style.display = "none"; }

function renderLog() {
  const q = (search.value || "").toLowerCase();
  logContent.innerHTML = db[currentLog]
    .filter(i => JSON.stringify(i).toLowerCase().includes(q))
    .map((i, idx) => `<div class="list-item" onclick='showDetail(${JSON.stringify(i)},"${currentLog}",${idx})'>${i.Ø§Ù„ÙØ¦Ø© || i.Ø§Ù„Ù†ÙˆØ¹ || i.Ø§Ù„Ø§Ø³Ù…} - ${i.Ø§Ù„Ù…Ø¨Ù„Øº}</div>`)
    .join("");
}

function showDetail(o, type, index) {
  editMode = { type, index }; // ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù‡Ø°Ø§ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¹Ù…Ù„ÙŠØªÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù)
  detailModal.style.display = "flex";
  detailContent.innerHTML = Object.entries(o).map(([k, v]) => {
    if (k === "ØµÙˆØ±Ø©" && v) return `<p><b>ØµÙˆØ±Ø©:</b></p><img src="${v}">`;
    if (k === "id") return ""; 
    return `<p><b>${k}:</b> ${v || "â€”"}</p>`;
  }).join("") + `<button class="action" onclick="editTransaction()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
  <button class="secondary" onclick="deleteTransaction()">ğŸ—‘ï¸ Ø­Ø°Ù</button>`;
}

function editTransaction() {
  const currentData = db[editMode.type][editMode.index];

  if (editMode && editMode.type === "exp") {
    eAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    eType.value = currentData.Ø§Ù„ÙØ¦Ø©;
    eDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    eDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
  }
  if (editMode && editMode.type === "rig") {
    rName.value = currentData.Ø§Ù„Ø§Ø³Ù…;
    rAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    rDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    rDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
    rStatus.value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
  }
  if (editMode && editMode.type === "deb") {
    dType.value = currentData.Ø§Ù„Ù†ÙˆØ¹;
    dAmount.value = currentData.Ø§Ù„Ù…Ø¨Ù„Øº;
    dDesc.value = currentData.Ø§Ù„ÙˆØµÙ;
    dDate.value = currentData.Ø§Ù„ØªØ§Ø±ÙŠØ®;
    dStatus.value = currentData.Ø§Ù„Ø­Ø§Ù„Ø©;
  }
  
  document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));

  let targetTab;
  if (editMode.type === "exp") targetTab = 'expenses';
  else if (editMode.type === "rig") targetTab = 'rights';
  else if (editMode.type === "deb") targetTab = 'debts';

  document.getElementById(targetTab).classList.add("active");
  document.querySelector(`[onclick="openTab('${targetTab}')"]`).classList.add("active");

  detailModal.style.display = "none";
}

async function deleteTransaction() {
  if (!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ")) return;
  
  const idToDelete = db[editMode.type][editMode.index].id;
  
  try {
      await deleteFromDB(editMode.type, idToDelete);
      editMode = null; 
      await loadAllData(); 
      toastMsg("ØªÙ… Ø§Ù„Ø­Ø°Ù");
      detailModal.style.display = "none";
      updateStats();
  } catch (error) {
      toastMsg("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù.");
      console.error(error);
  }
}

// ===================================================
// 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Stats)
// ===================================================

function updateStats() {
  let et = 0, ec = db.exp.length;
  let cats = {}; 
  
  let rt = 0, rp = 0, ru = 0;
  let dt = 0, dp = 0, du = 0;

  db.exp.forEach(e => { 
    let a = parseAmount(e.Ø§Ù„Ù…Ø¨Ù„Øº); 
    et += a; 
    cats[e.Ø§Ù„ÙØ¦Ø©] = (cats[e.Ø§Ù„ÙØ¦Ø©] || 0) + a;
  });

  let topCatName = 'â€”';
  let maxCatAmount = 0;
  for (let cat in cats) { 
    if (cats[cat] > maxCatAmount) {
      maxCatAmount = cats[cat];
      topCatName = cat;
    }
  }

  db.rig.forEach(r => { 
    let a = parseAmount(r.Ø§Ù„Ù…Ø¨Ù„Øº); 
    rt += a; 
    r.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹" ? rp += a : ru += a;
  });

  db.deb.forEach(d => { 
    let a = parseAmount(d.Ø§Ù„Ù…Ø¨Ù„Øº); 
    dt += a; 
    d.Ø§Ù„Ø­Ø§Ù„Ø© === "Ù…Ø¯ÙÙˆØ¹" ? dp += a : du += a;
  });

  sExpTotal.textContent = et.toLocaleString(); 
  sExpCount.textContent = ec;
  sTopCat.textContent = topCatName;

  sRigTotal.textContent = rt.toLocaleString(); 
  sRigPaid.textContent = rp.toLocaleString(); 
  sRigUnpaid.textContent = ru.toLocaleString();
  
  sDebTotal.textContent = dt.toLocaleString(); 
  sDebPaid.textContent = dp.toLocaleString(); 
  sDebUnpaid.textContent = du.toLocaleString();
}
</script>

</body>
</html>
