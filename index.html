<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</title>

<style>
:root{--primary:#0d6efd;--success:#28a745;--bg:#f4f6f8}
body{margin:0;font-family:Tahoma,Arial;background:var(--bg)}
header{background:var(--primary);color:#fff;padding:15px;text-align:center;font-size:20px}
.tabs{display:flex;background:#fff}
.tabs button{flex:1;padding:12px;border:none;background:#fff}
.tabs button.active{background:var(--primary);color:#fff}
.section{display:none;padding:15px}
.section.active{display:block}
.card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px}
input,select{width:100%;padding:12px;margin:6px 0;font-size:15px;border-radius:8px;border:1px solid #ccc}
button.action{background:var(--success);color:#fff;border:none;padding:14px;width:100%;border-radius:8px;font-size:16px}
button.secondary{background:#ddd;padding:10px;width:100%;border:none;border-radius:8px;margin-top:6px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 22px;border-radius:30px;display:none}
.toast.show{display:block}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:none;flex-direction:column;z-index:10}
.modal header{display:flex;gap:6px;padding:10px;border-bottom:1px solid #ddd}
.modal-content{padding:15px;overflow:auto;flex:1}
.list-item{background:#eef6ff;padding:14px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.detail p{margin:8px 0;font-size:15px}
.detail img{width:100%;border-radius:10px;margin-top:10px}
</style>
</head>

<body>

<header>Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</header>

<div class="tabs">
<button class="active" onclick="openTab('expenses')">ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª</button>
<button onclick="openTab('rights')">ğŸ¤ Ø­Ù‚ÙˆÙ‚</button>
<button onclick="openTab('debts')">ğŸ“Œ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</button>
</div>

<!-- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
<div id="expenses" class="section active">
<div class="card">
<input id="eAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="numeric" oninput="formatAmount(this)">
<select id="eType">
<option value="">Ø§Ù„ÙØ¦Ø©</option>
<option>Ø·Ø¹Ø§Ù…</option><option>Ù…ÙˆØ§ØµÙ„Ø§Øª</option><option>ÙÙˆØ§ØªÙŠØ±</option>
<option>Ø¥ÙŠØ¬Ø§Ø±</option><option>ØµØ­Ø©</option><option>ØªØ±ÙÙŠÙ‡</option><option>ØªØ³ÙˆÙ‚</option>
</select>
<input id="eDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<input id="eDate" type="datetime-local" placeholder="ğŸ“… Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®">
<input id="eImg" type="file" accept="image/*">
<button class="action" onclick="addExpense()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('exp')">ğŸ“‚ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<!-- Ø§Ù„Ø­Ù‚ÙˆÙ‚ -->
<div id="rights" class="section">
<div class="card">
<input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ">
<select id="rType">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚</option>
<option>Ø¯ÙŠÙ† Ø´Ø®ØµÙŠ</option><option>Ø³Ù„ÙØ©</option><option>Ø¨ÙŠØ¹</option><option>Ù…Ø´Ø§Ø±ÙƒØ©</option>
</select>
<input id="rAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="numeric" oninput="formatAmount(this)">
<input id="rDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<input id="rDate" type="datetime-local" placeholder="ğŸ“… Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®">
<select id="rStatus"><option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option><option>Ù…Ø¯ÙÙˆØ¹</option><option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option></select>
<button class="action" onclick="addRight()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('rig')">ğŸ“‚ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<!-- Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª -->
<div id="debts" class="section">
<div class="card">
<select id="dType">
<option value="">Ù†ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</option>
<option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>Ù…Ø§Ø¡</option><option>Ø¥Ù†ØªØ±Ù†Øª</option>
<option>Ø¥ÙŠØ¬Ø§Ø±</option><option>Ø¯ÙŠÙ†</option>
</select>
<input id="dAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" inputmode="numeric" oninput="formatAmount(this)">
<input id="dDesc" placeholder="ÙˆØµÙ / Ù…Ù„Ø§Ø­Ø¸Ø©">
<input id="dDate" type="datetime-local" placeholder="ğŸ“… Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®">
<select id="dStatus"><option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option><option>Ù…Ø¯ÙÙˆØ¹</option><option>ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option></select>
<button class="action" onclick="addDebt()">Ø­ÙØ¸</button>
<button class="secondary" onclick="openLog('deb')">ğŸ“‚ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
</div>
</div>

<!-- Ø§Ù„Ø³Ø¬Ù„ -->
<div class="modal" id="logModal">
<header>
<input id="search" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„" oninput="renderLog()">
<button onclick="closeLog()">Ø¥ØºÙ„Ø§Ù‚</button>
</header>
<div class="modal-content" id="logContent"></div>
</div>

<!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div class="modal" id="detailModal">
<header><button onclick="detailModal.style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button></header>
<div class="modal-content detail" id="detailContent"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const db={
exp:JSON.parse(localStorage.getItem("exp"))||[],
rig:JSON.parse(localStorage.getItem("rig"))||[],
deb:JSON.parse(localStorage.getItem("deb"))||[]
};
let currentLog="";

// ====== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======

if ("Notification" in window) {
    Notification.requestPermission();
}

const notified = JSON.parse(localStorage.getItem("notified")) || [];

// ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function checkNotifications() {
    const now = new Date().getTime();

    // Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª
    db.deb.forEach((d, i) => {
        if (d.Ø§Ù„Ø­Ø§Ù„Ø© !== "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹") return;

        const time = new Date(d.Ø§Ù„ØªØ§Ø±ÙŠØ®).getTime();
        const id = "deb-" + i;

        // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ¹Ø¯
        if (now >= time && !notified.includes(id)) {
            sendNotification(
                "ğŸ“Œ Ø§Ù„ØªØ²Ø§Ù… Ù…Ø³ØªØ­Ù‚",
                `Ù„Ø¯ÙŠÙƒ ${d.Ø§Ù„Ù†ÙˆØ¹} Ø¨Ù‚ÙŠÙ…Ø© ${d.Ø§Ù„Ù…Ø¨Ù„Øº}`
            );
            notified.push(id);
        }
    });

    // Ø§Ù„Ø­Ù‚ÙˆÙ‚
    db.rig.forEach((r, i) => {
        if (r.Ø§Ù„Ø­Ø§Ù„Ø© !== "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹") return;

        const time = new Date(r.Ø§Ù„ØªØ§Ø±ÙŠØ®).getTime();
        const id = "rig-" + i;

        if (now >= time && !notified.includes(id)) {
            sendNotification(
                "ğŸ¤ Ø­Ù‚ ØºÙŠØ± Ù…Ø³Ø¯Ø¯",
                `${r.Ø§Ù„Ø§Ø³Ù…} Ø¹Ù„ÙŠÙ‡ ${r.Ø§Ù„Ù…Ø¨Ù„Øº} (${r.Ø§Ù„Ù†ÙˆØ¹})`
            );
            notified.push(id);
        }
    });

    localStorage.setItem("notified", JSON.stringify(notified));
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
function sendNotification(title, body) {
    if (Notification.permission === "granted") {
        new Notification(title, {
            body: body,
            icon: "ğŸ””"
        });
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
checkNotifications();

// ÙØ­Øµ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(checkNotifications, 60000);

// =======================
function formatAmount(el){
    el.value=el.value.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,",");
}

function toastMsg(m){
    const t=document.getElementById("toast");
    t.textContent=m;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2500);
}

function openTab(id){
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    event.target.classList.add("active");
}

function save(){
    localStorage.setItem("exp",JSON.stringify(db.exp));
    localStorage.setItem("rig",JSON.stringify(db.rig));
    localStorage.setItem("deb",JSON.stringify(db.deb));
}

function resetExpense(){eAmount.value=eDesc.value="";eType.value="";eDate.value="";eImg.value=""}
function resetRight(){rName.value=rAmount.value=rDesc.value="";rType.value=rStatus.value="";rDate.value=""}
function resetDebt(){dAmount.value=dDesc.value="";dType.value=dStatus.value="";dDate.value=""}

function addExpense(){
    if(!eAmount.value||!eType.value||!eDate.value)return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    const r=new FileReader();
    r.onload=()=>{
        db.exp.unshift({Ø§Ù„Ù…Ø¨Ù„Øº:eAmount.value,Ø§Ù„ÙØ¦Ø©:eType.value,Ø§Ù„ÙˆØµÙ:eDesc.value,Ø§Ù„ØªØ§Ø±ÙŠØ®:eDate.value,ØµÙˆØ±Ø©:r.result||null});
        save();resetExpense();toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ");
    };
    eImg.files[0]?r.readAsDataURL(eImg.files[0]):r.onload();
}

function addRight(){
    if(!rName.value||!rAmount.value||!rDate.value||!rStatus.value)return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    db.rig.unshift({Ø§Ù„Ø§Ø³Ù…:rName.value,Ø§Ù„Ù†ÙˆØ¹:rType.value,Ø§Ù„Ù…Ø¨Ù„Øº:rAmount.value,Ø§Ù„ÙˆØµÙ:rDesc.value,Ø§Ù„ØªØ§Ø±ÙŠØ®:rDate.value,Ø§Ù„Ø­Ø§Ù„Ø©:rStatus.value});
    save();resetRight();toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ù‚");
}

function addDebt(){
    if(!dType.value||!dAmount.value||!dDate.value||!dStatus.value)return toastMsg("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    db.deb.unshift({Ø§Ù„Ù†ÙˆØ¹:dType.value,Ø§Ù„Ù…Ø¨Ù„Øº:dAmount.value,Ø§Ù„ÙˆØµÙ:dDesc.value,Ø§Ù„ØªØ§Ø±ÙŠØ®:dDate.value,Ø§Ù„Ø­Ø§Ù„Ø©:dStatus.value});
    save();resetDebt();toastMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…");
}

function openLog(t){
    currentLog=t;
    logModal.style.display="flex";
    renderLog();
}

function closeLog(){
    logModal.style.display="none";
}

function renderLog(){
    const q=(search.value||"").toLowerCase();
    const list=db[currentLog].filter(i=>JSON.stringify(i).toLowerCase().includes(q));
    logContent.innerHTML=list.map(i=>{
        const title=`${i.Ø§Ù„ÙØ¦Ø©||i.Ø§Ù„Ù†ÙˆØ¹} - ${i.Ø§Ù„Ù…Ø¨Ù„Øº}`;
        return `<div class="list-item" onclick='showDetail(${JSON.stringify(i)})'>${title}</div>`;
    }).join("");
}

function showDetail(o){
    detailModal.style.display="flex";
    detailContent.innerHTML=Object.entries(o).map(([k,v])=>{
        if(k==="ØµÙˆØ±Ø©" && v) return `<p><b>ØµÙˆØ±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</b></p><img src="${v}">`;
        return `<p><b>${k}:</b> ${v||"â€”"}</p>`;
    }).join("");
}
</script>

</body>
</html>

